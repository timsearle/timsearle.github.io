{% if page.slides %}
{% assign slide_folder = page.slides %}
{% assign slides_path = '/assets/slides/' | append: slide_folder %}
{% assign slide_id = 'slides-' | append: slide_folder | slugify %}
{% capture slide_prefix %}{{ slides_path }}/slide{% endcapture %}
{% assign slide_files = site.static_files | where_exp: "file", "file.path contains slide_prefix" %}
{% assign initial_slide_count = slide_files | size %}
{% if initial_slide_count == 0 %}
  {% assign initial_slide_count = 1 %}
{% endif %}

<div class="slides-container" id="{{ slide_id }}" data-slides-path="{{ slides_path }}" data-total-slides="{{ initial_slide_count }}">
  <div class="slide-presentation" role="region" aria-label="Slide deck">
    <div class="slide-viewer">
      <img data-role="current-slide" src="{{ slides_path }}/slide1.png" alt="Slide 1" loading="lazy" />
    </div>

    <div class="slide-controls" role="group" aria-label="Slide navigation">
      <button type="button" class="slide-btn" data-role="prev-slide" disabled aria-label="Previous slide">← Previous</button>
      <span class="slide-counter" aria-live="polite">
        <span data-role="current-slide-num">1</span>
        /
        <span data-role="total-slides">{{ initial_slide_count }}</span>
      </span>
      <button type="button" class="slide-btn" data-role="next-slide" aria-label="Next slide">Next →</button>
    </div>

    <div class="slide-slider-container">
      <input
        type="range"
        class="slide-slider"
        data-role="slider"
        min="1"
        max="{{ initial_slide_count }}"
        value="1"
        aria-label="Slide selector"
      />
    </div>
  </div>

  <div class="slide-instructions">
    <p><em>Use the Previous/Next buttons, the slider, or your keyboard arrow keys to navigate through the presentation.</em></p>
  </div>
</div>

<script>
(() => {
  const container = document.getElementById('{{ slide_id }}');
  if (!container) return;

  const slidesPath = container.dataset.slidesPath;
  let totalSlides = Math.max(1, Number(container.dataset.totalSlides) || 1);
  let currentSlide = 1;

  const currentSlideImg = container.querySelector('[data-role="current-slide"]');
  const currentSlideNum = container.querySelector('[data-role="current-slide-num"]');
  const totalSlidesEl = container.querySelector('[data-role="total-slides"]');
  const prevBtn = container.querySelector('[data-role="prev-slide"]');
  const nextBtn = container.querySelector('[data-role="next-slide"]');
  const slideSlider = container.querySelector('[data-role="slider"]');

  if (!currentSlideImg || !currentSlideNum || !totalSlidesEl || !prevBtn || !nextBtn || !slideSlider) {
    return;
  }

  const slideCache = new Map();

  function updateControls() {
    prevBtn.disabled = currentSlide <= 1;
    nextBtn.disabled = currentSlide >= totalSlides;
  }

  function preloadSlide(index) {
    if (!Number.isFinite(index) || index < 1 || index > totalSlides || slideCache.has(index)) {
      return;
    }
    const img = new Image();
    img.src = `${slidesPath}/slide${index}.png`;
    slideCache.set(index, true);
  }

  function setSlide(slideNumber) {
    currentSlideImg.src = `${slidesPath}/slide${slideNumber}.png`;
    currentSlideImg.alt = `Slide ${slideNumber}`;
    currentSlideNum.textContent = slideNumber;
    slideSlider.value = slideNumber;
    totalSlidesEl.textContent = totalSlides;

    preloadSlide(slideNumber + 1);
    preloadSlide(slideNumber + 2);
    preloadSlide(slideNumber - 1);

    updateControls();
  }

  function goToSlide(target) {
    const next = Math.min(Math.max(Number(target) || 1, 1), totalSlides);
    if (next === currentSlide) return;
    currentSlide = next;
    setSlide(currentSlide);
  }

  function finalizeTotal(count) {
    const nextTotal = Math.max(1, Number(count) || 1);
    if (nextTotal === totalSlides) {
      updateControls();
      return;
    }
    totalSlides = nextTotal;
    slideSlider.max = totalSlides;
    if (currentSlide > totalSlides) {
      currentSlide = totalSlides;
    }
    setSlide(currentSlide);
  }

  function probeForSlides(limit = 200) {
    let highest = 0;

    const check = (index) => {
      if (index > limit) {
        finalizeTotal(highest || totalSlides);
        return;
      }

      const img = new Image();
      img.onload = () => {
        highest = index;
        check(index + 1);
      };
      img.onerror = () => {
        finalizeTotal(highest || totalSlides);
      };
      img.src = `${slidesPath}/slide${index}.png`;
    };

    check(1);
  }

  prevBtn.addEventListener('click', () => goToSlide(currentSlide - 1));
  nextBtn.addEventListener('click', () => goToSlide(currentSlide + 1));

  slideSlider.addEventListener('input', (event) => {
    goToSlide(event.target.value);
  });

  const keyHandler = (event) => {
    const targetTag = event.target && event.target.tagName;
    if (targetTag && ['INPUT', 'TEXTAREA', 'SELECT'].includes(targetTag)) {
      return;
    }
    const active = document.activeElement;
    if (active && active !== document.body && !container.contains(active)) {
      return;
    }

    if (event.key === 'ArrowLeft') {
      event.preventDefault();
      goToSlide(currentSlide - 1);
    } else if (event.key === 'ArrowRight') {
      event.preventDefault();
      goToSlide(currentSlide + 1);
    }
  };

  document.addEventListener('keydown', keyHandler);

  slideSlider.max = totalSlides;
  setSlide(currentSlide);

  if (totalSlides <= 1) {
    probeForSlides();
  }
})();
</script>

<style>
.slides-container {
  margin: 2rem 0;
  text-align: center;
}

.slide-presentation {
  border: 1px solid var(--color-border);
  padding: 1.5rem;
  background: var(--color-bg-alt);
}

.slide-viewer {
  margin-bottom: 1.5rem;
}

.slide-viewer img {
  max-width: 100%;
  height: auto;
  background: var(--color-bg);
}

.slide-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
}

.slide-btn {
  padding: 0.6rem 1.5rem;
  border: 1px solid var(--color-border);
  background: var(--color-bg);
  cursor: pointer;
  font-size: 0.75rem;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  touch-action: manipulation;
  color: var(--color-text);
  transition: background 0.2s ease, color 0.2s ease;
}

.slide-btn:hover:not(:disabled) {
  background: var(--color-bg-alt);
  color: var(--color-accent);
}

.slide-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.slide-counter {
  font-size: 0.75rem;
  font-family: var(--font-mono);
  color: var(--color-text-tertiary);
  min-width: 60px;
  font-variant-numeric: tabular-nums;
}

.slide-slider-container {
  margin-top: 1rem;
  padding: 0 1rem;
}

.slide-slider {
  width: 100%;
  height: 4px;
  background: var(--color-border);
  outline: none;
  transition: background 0.2s ease;
  -webkit-appearance: none;
  appearance: none;
}

.slide-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--color-accent);
  cursor: pointer;
}

.slide-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--color-accent);
  cursor: pointer;
  border: none;
}

.slide-instructions {
  margin-top: 1rem;
  text-align: center;
  color: var(--color-text-tertiary);
  font-size: 0.75rem;
}

@media (max-width: 600px) {
  .slide-controls {
    flex-direction: column;
    gap: 0.5rem;
  }

  .slide-slider-container {
    width: 100%;
    padding: 0;
  }

  .slide-btn {
    width: 100%;
  }
}

@media (prefers-reduced-motion: reduce) {
  .slide-btn,
  .slide-slider {
    transition: none;
  }
}
</style>
{% endif %}
